name: Xóa run cũ

on:
  schedule:
    - cron: '0 0 * * *' 

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup GitHub CLI
        run: |
          sudo apt-get install -y gh jq
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Delete runs older than 14 days
        run: |
          gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] 
                  | select(.status=="completed") 
                  | select(.conclusion=="failure" or .conclusion=="cancelled") 
                  | select((now - (.created_at | fromdateiso8601)) > (14*24*3600)) 
                  | .id' > runs.txt

          while read run_id; do
            echo "Deleting run $run_id"
            gh api repos/${{ github.repository }}/actions/runs/$run_id -X DELETE
          done < runs.txt
