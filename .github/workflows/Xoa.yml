name: Cleanup workflow runs

on:
  workflow_dispatch:   # chạy thủ công
    inputs:
      days:
        description: "Số ngày giữ lại (ví dụ 30)"
        required: true
        default: "14"

  schedule:            # chạy tự động
    - cron: '0 0 * * 0'   # mỗi tuần vào Chủ Nhật 00:00 UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup GitHub CLI
        run: |
          sudo apt-get install -y gh jq
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Delete old runs
        run: |
          # Nếu chạy thủ công thì lấy input, nếu chạy tự động thì mặc định 14 ngày
          DAYS=${{ github.event.inputs.days || 14 }}

          # Lấy tất cả runs đã completed, không phân biệt trạng thái
          gh api repos/${{ github.repository }}/actions/runs \
            --jq ".workflow_runs[] 
                  | select(.status==\"completed\") 
                  | select((now - (.created_at | fromdateiso8601)) > ($DAYS*24*3600)) 
                  | .id" > runs.txt

          while read run_id; do
            echo "Deleting run $run_id"
            gh api repos/${{ github.repository }}/actions/runs/$run_id -X DELETE
          done < runs.txt
