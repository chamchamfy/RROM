#!/bin/bash
TOME="$GITHUB_WORKSPACE"
phanvungtam=$TOME/Unpack
[[ -f "$phanvungtam/odm/etc/build.prop" ]] && tenmamay=$(sudo grep 'ro.product.odm.device' $phanvungtam/odm/etc/build.prop | awk -F= '{print $2}' | awk '{$1=$1}{print}') || tenmamay=$(sudo grep 'ro.product.vendor.device' $phanvungtam/vendor/build.prop | awk -F= '{print $2}' | awk '{$1=$1}{print}')
API=$(sudo grep 'ro.build.version.sdk=' $phanvungtam/system/system/build.prop | awk -F= '{print $2}');
VERS=$(sudo grep 'ro.build.version.release=' $phanvungtam/system/system/build.prop | awk -F= '{print $2}');
# Thư mục chứa apk,jar đã mod: $TOME/Mod
# Tìm tập tin apk,jar chép vào $TOME/Mod: [ Timfile *.apk/*.jar ]
# Giải nén dex trong apk/jar từ thư mục $TOME/Mod: [ Unpackfile ] 
# Đóng gói lại dex thành jar/apk vào thư mục $TOME/Mod: [ Repackfile ]
# Đường dẫn thư mục system: $phanvungtam/system/system 
# Đường dẫn thư mục vendor: $phanvungtam/vendor 
# Đường dẫn thư mục product: $phanvungtam/product 
# Đường dẫn thư mục system_ext: $phanvungtam/system_ext
########
cuphap1() {
echo " => Sử dụng theo cú pháp sau: suasmali1 <Tùy chỉnh>
      -Thay dòng:
       noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung cần tìm'; noidung='Nội dung cần thay'; thaydong
       
       -Thay dòng biến [x1 vx2, x3]:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung cần tìm'; biendau='Nội dung biến đầu'; biencuoi='Nội dung biến cuối'; thaydongbien 

	  -Thay đoạn:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandau='Số dòng cần tìm đầu'; timdau='Nội dung cần tìm đầu'; gioihancuoi='Số dòng cần tìm cuối'; timcuoi='Nội dung cần tìm cuối'; noidung='Nội dung thay'; thaydoan

	  -Thay đoạn biến [x1 vx2, x3]:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandau='Số dòng cần tìm đầu'; timdau='Nội dung cần tìm đầu'; gioihancuoi='Số dòng cần tìm cuối'; timcuoi='Nội dung cần tìm cuối'; biendau='Nội dung biến đầu'; biencuoi='Nội dung biến cuối'; thaydoanbien

	  -Thay đoạn cuối phương thức:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; cuoi='.end method'; noidung='Nội dung cần thay'; thaydoancuoi

	  -Thay chuỗi:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; noidungtim='Nội dung cần tìm'; noidung='Nội dung thay'; thaychuoi

	  -Thay nội dung:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; noidung='Nội dung thay'; thaynoidung

	  -Thay phương thức:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; cuoi='.end method'; noidung='Nội dung thay'; thayphuongthuc

	  -Chèn trước nội dung:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; noidung='Nội dung chèn trước'; chentruoc

	  -Chèn sau nội dung:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; noidung='Nội dung chèn sau'; chensau

	  -Chèn trước dòng:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung tìm'; noidung='Nội dung chèn trước dòng'; chentruocdong

	  -Chèn sau dòng:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung tìm'; noidung='Nội dung chèn sau dòng'; chensaudong

	  -Chèn trước dòng biến [x1 vx2, x3]:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung tìm'; biendau='Nội dung biến đầu'; biencuoi='Nội dung biến cuối'; chentruocdongbien

	  -Chèn sau dòng biến [x1 vx2, x3]:
	   noichua='Tên smali'; phuongthuc='Phương thức tìm'; gioihandong='Số dòng cần tìm'; noidungtim='Nội dung tìm'; biendau='Nội dung biến đầu'; biencuoi='Nội dung biến cuối'; chensaudongbien
     "
}
cuphap2() {
echo " => Sử dụng theo cú pháp sau: suasmali2 <Tùy chỉnh>
	  -Thay dòng:
	   thaydong 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm' 'Nội dung cần tìm' '0' '' 'Nội dung thay' 

	  -Thay dòng biến [x1 vx2, x3]:
	   thaydongbien 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm đầu' 'Nội dung cần tìm đầu' '0' '' 'Nội dung biến đầu' 'Nội dung biến cuối' 

	  -Thay đoạn:
	   thaydoan 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm đầu' 'Nội dung cần tìm đầu' 'Số dòng cần tìm cuối' 'Nội dung cần tìm cuối' 'Nội dung thay' 

	  -Thay đoạn biến [x1 vx2, x3]:
	   thaydoanbien 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm đầu' 'Nội dung cần tìm đầu' 'Số dòng cần tìm cuối' 'Nội dung cần tìm cuối' 'Nội dung biến đầu' 'Nội dung biến cuối'

	  -Thay đoạn cuối phương thức:
	   thaydoancuoi 'Tên smali' 'Phương thức tìm' '0' '' '0' '.end method' 'Nội dung thay' 

	  -Thay chuỗi:
	   thaychuoi 'Tên smali' 'Phương thức tìm' '0' 'Nội dung cần tìm' '0' '' 'Nội dung thay'

	  -Thay nội dung:
	   thaynoidung 'Tên smali' 'Phương thức tìm' 'Nội dung thay' 

	  -Thay phương thức:
	   thayphuongthuc 'Tên smali' 'Phương thức tìm' '0' '' '0' '.end method' 'Nội dung thay' 

	  -Chèn trước nội dung:
	   chentruoc 'Tên smali' 'Phương thức tìm' '0' '' '0' '' 'Nội dung chèn trước' 

	  -Chèn sau nội dung:
	   chensau 'Tên smali' 'Phương thức tìm' '0' '' '0' '' 'Nội dung chèn sau' 

	  -Chèn trước dòng:
	   chentruocdong 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm' 'Nội dung tìm' '0' '' 'Nội dung chèn trước dòng'

	  -Chèn sau dòng:
	   chensaudong 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm' 'Nội dung tìm' '0' '' 'Nội dung chèn sau dòng' 

	  -Chèn trước dòng biến [x1 vx2, x3]:
	   chentruocdongbien 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm đầu' 'Nội dung tìm đầu' 'Số dòng cần tìm cuối' 'Nội dung tìm cuối' 'Nội dung biến đầu' 'Nội dung biến cuối' 

	  -Chèn sau dòng biến [x1 vx2, x3]:
	   chensaudongbien 'Tên smali' 'Phương thức tìm' 'Số dòng cần tìm đầu' 'Nội dung tìm đầu' 'Số dòng cần tìm cuối' 'Nội dung tìm cuối' 'Nội dung biến đầu' 'Nội dung biến cuối' 
	"
}
#
#VD1: suasmali2; thaydong 'StrictJarVerifier.smali' 'Ljava/security/MessageDigest;->isEqual' '20' 'const/4 v1, 0x0' '0' '' 'const/4 v1, 0x1'
#
#VD2: suasmali2; thayphuongthuc 'PackageManagerServiceImpl.smali' '.method public static isCTS()Z' '0' '' '0' '.end method' 'const/4 v0, 0x1\n return v0\n'
########
Caidat() {
for tjar in Joyose1 Settings1 MIUISystemUIPlugin1 MIUIPackageInstaller1 MiuiSystemUI1; do
Timfile "$tjar.apk"
if [[ -f "$TOME/Mod/$tjar.apk" ]]; then 
echo " Xử lý: $tjar.apk"
Unpackfile
 if [[ "$tjar" == "Settings" ]]; then 
Tkm() {
suasmali2
thaychuoi 'MiuiSettings.smali' 'micloud_settings' '8' 'IS_INTERNATIONAL_BUILD' '0' '' 'IS_ALPHA_BUILD'
thaychuoi 'MiuiSettings.smali' 'mi_account_settings' '8' 'IS_INTERNATIONAL_BUILD' '0' '' 'IS_ALPHA_BUILD'
}
sudo sed -i 's/"MIUI "/"MIUICC "/g' $TOME/Mod/$tjar/classes*/com/android/settings/device/MiuiAboutPhoneUtils.smali 2>/dev/null
sudo sed -i 's/"by xiaomi.eu"/"by MIUICC "/g' $TOME/Mod/$tjar/classes*/com/android/settings/device/MiuiAboutPhoneUtils.smali 2>/dev/null
sudo sed -i 's/"ro.build.host"/"CC "/g' $TOME/Mod/$tjar/classes*/com/android/settings/device/MiuiAboutPhoneUtils.smali 2>/dev/null 
[[ "$TKM" == "1" ]] && Tkm
 fi
 if [[ "$tjar" == "Joyose" ]]; then 
   suasmali2; thaydong "GPUTUNER_SWITCH" 'GPUTUNER_SWITCH' '20' 'const/4 v0, 0x0' '0' '' 'const/4 v0, 0x1'
 fi
 if [[ "$tjar" == "MIUISystemUIPlugin" ]]; then 
  suasmali2; thayphuongthuc 'MiPlayController.smali' 'supportMiPlayAudio()' '0' '' '0' '.end method' 'const/4 p0, 0x1\n return p0\n'
 fi
 if [[ "$tjar" == "MIUIPackageInstaller" ]]; then 
  for taptin in $(find $TOME/Mod/$tjar -type f -name '*.smali'); do
   noichua=${taptin##*/}
   suasmali2; chensaudong "$noichua" '.method public static a(Landroid/content/pm/ApplicationInfo;)Z' '2' '.register' '0' '' 'const/4 v0, 0x0\n return v0'
  done
 fi
 if [[ "$tjar" == "MiuiSystemUI" ]]; then 
  suasmali2; thaydong 'PrivacyItemControllerler.smali' 'isMicicCameraAndabled(' '20' 'move-result p0' '0' '' 'const/4 p0, 0x0'
 fi
Repackfile
fi 
done
}
Caidat
#
tinhnang() {
for p in $phanvungtam/product/etc/device_features/*.xml $phanvungtam/vendor/etc/device_features/*.xml; do
 if [ -f "$p" ]; then
   if [ -z "$(sudo grep 'miui_volume_expand_freeland' $p)" ]; then 
    b='<bool name="config_sunlight_mode_available">true</bool>\n    <bool name="enable_flash_global">true</bool>\n    <bool name="is_support_fingerprint_tap">true</bool>\n    <bool name="miui_volume_expand_freeland">true</bool>\n    <bool name="support_AI_display">true</bool>\n    <bool name="support_backlight_bit_switch">true</bool>\n    <bool name="support_decrease_brightness_spec_app">true</bool>\n    <bool name="support_displayfeature_gamemode">true</bool>\n    <bool name="support_dolby_version_brighten">true</bool>\n    <bool name="support_game_dim">true</bool>\n    <bool name="support_game_gunsight">true</bool>\n    <bool name="support_led_color">true</bool>\n    <bool name="support_led_light">true</bool>\n    <bool name="support_local_ocr">true</bool>\n    <bool name="support_manual_brightness_boost">true</bool>\n    <bool name="support_mi_game_macro">true</bool>\n    <bool name="support_power_save_new">true</bool>\n    <bool name="support_screen_enhance_engine">true</bool>\n    <bool name="support_sound_assist">true</bool>\n    <bool name="support_tap_fingerprint_sensor_to_home">true</bool>\n    <bool name="support_ui_orientation_v2">true</bool>\n    <bool name="support_wild_boost">true</bool>\n    <bool name="support_wild_boost_bat_perf">true</bool>\n    <bool name="support_edgesuppression_with_sensor">true</bool>\n    <integer-array name="edge_suppresson_absolute"> <item>0</item> <item>0</item> <item>0</item> <item>5</item> <item>5</item> </integer-array>\n    <integer-array name="edge_suppresson_condition"> <item>60</item> <item>20</item> <item>50</item> <item>75</item> <item>100</item> <item>100</item> </integer-array>\n    <integer-array name="edge_suppresson_corner"> <item>180</item> <item>400</item> <item>280</item> <item>280</item> <item>150</item> <item>300</item> <item>250</item> <item>400</item> <item>180</item> <item>400</item> </integer-array>\n    <integer-array name="edge_suppresson_size"> <item>12</item> <item>96</item> </integer-array>\n    <bool name="support_smart_fps">true</bool>\n    <integer name="support_max_fps">144</integer>\n    <integer-array name="fpsList"> <item>144</item> <item>120</item> <item>90</item> <item>60</item> </integer-array>\n    <bool name="support_high_resolution">true</bool>\n    <integer-array name="screen_resolution_supported"> <item>1220</item> <item>1080</item> </integer-array>\n    <bool name="support_multi_face_input">true</bool>\n    <bool name="support_multi_face_input_global">true</bool>\n    <string-array name="support_face_unlock_region_dom"> <item>ALL</item> </string-array>\n    <string-array name="support_face_unlock_region_global"> <item>ALL</item> </string-array>\n    <integer name="config_screenBrightnessDim">13</integer>\n    <integer name="config_screenBrightnessSettingDefault">614</integer>\n    <integer name="config_screenBrightnessSettingMinimum">12</integer>\n    <integer name="config_screenBrightnessSettingMaximum">8191</integer>\n    <integer name="config_screenBrightnessDim_hyper">13</integer>\n    <integer name="config_screenBrightnessSettingDefault_hyper">614</integer>\n    <integer name="config_screenBrightnessSettingMinimum_hyper">12</integer>\n    <integer name="config_screenBrightnessSettingMaximum_hyper">8191</integer>\n</features>'
    sudo sed -i "s|</features>|$b|" $p
   fi
 fi
done
} 

themcauhinh() { 
# Thêm file_contexts
systemfc="/system/lib64/libGLESv1\.so u:object_r:system_lib_file:s0
/system/lib64/libGLESv2\.so u:object_r:system_lib_file:s0
/system/lib/libGLESv1\.so u:object_r:system_lib_file:s0
/system/lib/libGLESv2\.so u:object_r:system_lib_file:s0"
#
vendorfc="/vendor/etc/audio/sku_cape u:object_r:system_file:s0
/vendor/etc/audio/sku_cape/mixer_paths_overlay_static\.xml u:object_r:system_file:s0
/vendor/etc/dolby/daxa-default\.xml u:object_r:system_file:s0
/vendor/etc/dolby/daxd-default\.xml u:object_r:system_file:s0
/vendor/etc/dolby/dax-default\.xml u:object_r:system_file:s0
/vendor/etc/dolby_vision\.cfg u:object_r:system_file:s0"
#
productfc=""
#
system_extfc="/system_ext/etc/cust_prop_white_keys_list u:object_r:system_file:s0"
#
# Thêm fsconfig
systemfs="system/lib64/libGLESv1.so 0 0 0644
system/lib64/libGLESv2.so 0 0 0644
system/lib/libGLESv1.so 0 0 0644
system/lib/libGLESv2.so 0 0 0644"
#
vendorfs="vendor/etc/audio/sku_cape 0 0 0755
vendor/etc/audio/sku_cape/mixer_paths_overlay_static.xml 0 0 0644
vendor/etc/dolby/daxa-default.xml 0 0 0644
vendor/etc/dolby/daxd-default.xml 0 0 0644
vendor/etc/dolby/dax-default.xml 0 0 0644
vendor/etc/dolby_vision.cfg 0 0 0644"
#
productfs=""
#
system_extfs="system_ext/etc/cust_prop_white_keys_list 0 0 0644"
}
#
ngonngu() { 
if [[ "$TTV" == "1" ]]; then 
mkdir -p $TOME/VH
Taive "https://github.com/chamchamfy/toolcc/raw/main/overlay.zip" "$TOME/VH.zip"
[ ! -f "$TOME/VH.zip" ] && Taivewget "https://github.com/chamchamfy/toolcc/raw/main/overlay.zip" "$TOME/VH.zip"
if [[ -s "$TOME/VH.zip" ]]; then echo " * Thêm ngôn ngữ..."
7za x -tzip -y "$TOME/VH.zip" -o$TOME/VH >/dev/null
[[ -e "$phanvungtam/product/overlay" ]] && TMVH=$phanvungtam/product/overlay || TMVH=$phanvungtam/vendor/overlay
sudo cp -rf $TOME/VH/apk/* $TMVH
sudo cp -rf $TOME/VH/cc.*.apk $TMVH
sudo rm -rf $TOME/VH
fi
fi
} 
ngonngu
#
if [[ "$HK" == "1" ]]; then echo " * Thêm Harman Kardon..."
mkdir -p $TOME/tam
7za x -tzip -y $TOME/.github/HarmanKardon.zip -o$TOME/tam >/dev/null
sudo cp -rf $TOME/tam/system/vendor/* $phanvungtam/vendor 
for tt in $(find $TOME/tam/system/vendor -type f); do sudo bash -c "echo '${tt//$TOME\/tam\/system\//} 0 0 0644' >> $TOME/vfs"; done
for tt in $(find $TOME/tam/system/vendor -type d); do sudo bash -c "echo '${tt//$TOME\/tam\/system\//} 0 0 0755' >> $TOME/vfs"; done
for i in vfs vfc; do [ -f "$TOME/$i" ] && sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done
sudo rm -rf $TOME/tam
fi 
#
if [[ "$AP" == "1" ]]; then 
mkdir -p $TOME/tam/cauhinh/system_ext/apex
Taive "https://sourceforge.net/projects/rrom/files/apex.tar.zst" "$TOME/tam/apex.tar.zst"
 if [ "$(sha1sum "$TOME/tam/apex.tar.zst" | awk '{OFMT="%.0f"; print $1}')" = "e6eecdd5476857ad124a20cbc0b44b19aac3c996" ]; then echo " * Thêm APEX..."
 zstd -d $TOME/tam/apex.tar.zst -o $TOME/tam/apex.tar >/dev/null
 7z e -y $TOME/tam/apex.tar -o$TOME/tam/cauhinh/system_ext/apex >/dev/null
 sudo cp -rf $TOME/tam/cauhinh/system_ext/* $phanvungtam/system_ext
 for tt in $(find $TOME/tam/cauhinh/system_ext -type f); do sudo bash -c "echo '${tt//$TOME\/tam\/cauhinh\//} 0 0 0644' >> $TOME/sefs"; ttm="${tt//$TOME\/tam\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/sefc"; done
 for i in sefs sefc; do [ -f "$TOME/$i" ] && sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done
 fi
sudo rm -rf $TOME/tam
fi

if [[ "$AGPU" == "725" ]]; then 
 Taive "https://github.com/chamchamfy/toolcc/raw/main/AdrenoGPUDriver725.zip" "$TOME/AdrenoGPUDriver.zip"
 elif [[ "$AGPU" == "615" ]]; then 
 Taive "https://github.com/chamchamfy/toolcc/raw/main/AdrenoGPUDriver615.zip" "$TOME/AdrenoGPUDriver.zip"
 fi 
if [[ -s "$TOME/AdrenoGPUDriver.zip" ]]; then echo " * Thêm Adreno GPU Driver $AGPU..."
mkdir -p $TOME/tam
7za x -tzip -y $TOME/AdrenoGPUDriver.zip -o$TOME/tam >/dev/null
sudo cp -rf $TOME/tam/system/vendor/* $phanvungtam/vendor 
for tt in $(find $TOME/tam/system/vendor -type f); do sudo bash -c "echo '${tt//$TOME\/tam\/system\//} 0 0 0644' >> $TOME/vfs"; ttm="${tt//$TOME\/tam\/system/}"; if [ -n "$(echo $ttm | grep '/firmware')" ]; then sudo bash -c "echo '${ttm//./\\.} u:object_r:vendor_firmware_file:s0' >> $TOME/vfc"; elif [ -n "$(echo $ttm | grep 'egl/')" -o -n "$(echo $ttm | grep 'libdmabufheap.so')" ]; then sudo bash -c "echo '${ttm//./\\.} u:object_r:system_lib_file:s0' >> $TOME/vfc"; else sudo bash -c "echo '$(echo ${ttm//./\\.} | sed -z 's/+/\\+/g') u:object_r:same_process_hal_file:s0' >> $TOME/vfc"; fi; done
for tt in $(find $TOME/tam/system/vendor -type d); do sudo bash -c "echo '${tt//$TOME\/tam\/system\//} 0 0 0755' >> $TOME/vfs"; ttm="${tt//$TOME\/tam\/system/}"; [ -n "$(echo $ttm | grep '/firmware')" ] && sudo bash -c "echo '${ttm//./\\.} u:object_r:vendor_firmware_file:s0' >> $TOME/vfc" || sudo bash -c "echo '$(echo ${ttm//./\\.} | sed -z 's/+/\\+/g') u:object_r:same_process_hal_file:s0' >> $TOME/vfc"; done
for i in vfs vfc; do [ -f "$TOME/$i" ] && sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done
sudo rm -rf $TOME/tam $TOME/AdrenoGPUDriver.zip
fi 
#
#[[ "$tenmamay" == "vili" ]] && sudo cp -rf $TOME/.github/libpy/vili/* $phanvungtam
tinhnang
#
thempersist() {
if [[ "$tenmamay" == "vili" ]]; then 
 if [[ ! -f "$TOME/.github/libpy/Flash2in1/images/persist.img" ]]; then 
  if [[ -n "$(echo "$URL" | grep 'MIXM')" ]]; then linkps="https://github.com/chamchamfy/toolcc/raw/main/persist_${tenmamay}gl.zip"; elif [[ -n "$(echo "$URL" | grep 'TWXM')" ]]; then linkps="https://github.com/chamchamfy/toolcc/raw/main/persist_${tenmamay}tw.zip"; fi
  Taive "$linkps" "$TOME/persist.zip"
  [[ -s "$TOME/persist.zip" ]] && 7za e -tzip -y $TOME/persist.zip *.img -o$TOME/.github/libpy/Flash2in1/images/ >/dev/null 2>&1 && rm -rf $TOME/persist.zip 2>/dev/null
 fi
fi
}
#thempersist
#[ -f "$TOME/.github/libpy/Flash2in1/images/persist.img" ] && echo " * Thêm persist..."
#
mkdir -p $TOME/twrp
taivetwrp() { LURL="https://sourceforge.net/projects/recovery-for-xiaomi-devices/files/$tenmamay"; TURL="$LURL/"$1"$(curl -s "$LURL/" | grep 'net.sf.files' | awk -F$1 '{print $4}' | awk -F/ '{print $1}')"; duoi=".${TURL##*.}"; Taive "$TURL" "$2$duoi"; } 
txrec() { [ -f $TOME/twrp/recovery.zip ] && 7za x -tzip -y $TOME/twrp/recovery.zip *.img -o$TOME/twrp/recovery.img >/dev/null && rm -f $TOME/twrp/recovery.zip 2>/dev/null; }
txtwrp() { [ -f $TOME/twrp/twrp.zip ] && 7za x -tzip -y $TOME/twrp/twrp.zip *.img -o$TOME/twrp/twrp.img >/dev/null && rm -f $TOME/twrp/twrp.zip 2>/dev/null; }
if [[ -n "$(grep 'recovery' $phanvungtam/vendor/etc/fstab.*)" ]]; then 
 if [[ "$MREC" == "OFOX" ]]; then 
  taivetwrp "OrangeFox-" "$TOME/twrp/recovery" 
  txrec
 elif [[ "$MREC" == "TWRP" ]]; then 
  taivetwrp "twrp-" "$TOME/twrp/recovery" || taivetwrp "boot" "$TOME/twrp/recovery"
  txrec
 elif [[ "$MREC" == "PBRB" ]]; then 
  taivetwrp "PBRP-" "$TOME/twrp/recovery"
  txrec
 fi
else 
 if [[ "$MREC" == "OFOX" ]]; then 
  taivetwrp "OrangeFox-" "$TOME/twrp/twrp" 
  txtwrp
 elif [[ "$MREC" == "TWRP" ]]; then 
  taivetwrp "twrp-" "$TOME/twrp/twrp" || taivetwrp "boot" "$TOME/twrp/twrp"
 elif [[ "$MREC" == "PBRP" ]]; then 
  taivetwrp "PBRP-" "$TOME/twrp/twrp"
  txtwrp
 fi
fi
[[ -n "$(ls $TOME/twrp/*.img 2>/dev/null)" ]] && echo " * Thêm Recovery $tenmamay..."
du -m $TOME/twrp/*.img 2>/dev/null
#
if [[ "$GAPP" == "1" ]]; then 
if [ "$VERS" == "12" ]; then PB=S; elif [ "$VERS" == "13" ]; then PB=T; elif [ "$VERS" == "14" ]; then PB=U; elif [ "$VERS" == "15" ]; then PB=V; elif [ "$VERS" == "16" ]; then PB=W; elif [ "$VERS" == "17" ]; then PB=X; elif [ "$VERS" == "18" ]; then PB=Y; elif [ "$VERS" == "19" ]; then PB=Z; fi
 tainikgapp() { LURL="https://sourceforge.net/projects/nikgapps/files/Releases/Android-${PB}"; Taive "$(curl -s "$LURL/$(curl -s "$LURL/" | grep 'net.sf.files' | awk -F'"' '{print $2}')/" | grep 'net.sf.files' | awk -F'"' '{print $286}')" "$TOME/$1"; } 
 taigapp() { LURL="https://sourceforge.net/projects/litegapps/files/litegapps/arm64/$2/$1"; Taive "$(curl -s "$LURL/$(curl -s "$LURL/" | grep 'net.sf.files' | awk -F'"' '{print $2}')/" | grep 'net.sf.files' | awk -F'"' '{print $14}')" "$TOME/$3"; } 
 taigboad() { LURL="https://sourceforge.net/projects/litegapps/files/addon/arm64/$2/$1/GoogleKeyboard"; Taive "$(curl -s "$LURL/" | grep 'net.sf.files' | awk -F'"' '{print $14}')" "$TOME/$3"; } 
 taigapp "core" "$API" "gapp.zip" || tainikgapp "nikgapp.zip"
 taigboad "gapps" "$API" "gboad.zip"
 
 if [[ "$(du -m $TOME/gboad.zip | awk '{print $1}')" -gt 30 ]]; then 
 #7za x -tzip -y $TOME/gboad.zip -o$TOME/gapp >/dev/null
 #sudo cp -rf $TOME/gapp/system/* $TOME/cauhinh 2>/dev/null 
 7za e -tzip -y $TOME/gboad.zip -o$TOME/gapp >/dev/null
 mkdir -p $TOME/cauhinh/product/app/LatinIMEGoogle
 sudo cp -rf $TOME/gapp/*.apk $TOME/cauhinh/product/app/LatinIMEGoogle/LatinIMEGoogle.apk 2>/dev/null 
 fi
 if [[ "$(du -m $TOME/gapp.zip | awk '{print $1}')" -gt 80 ]]; then echo " * Thêm Gói Gapp..."
 mkdir -p $TOME/gapp $TOME/cauhinh
 7za x -tzip -y $TOME/gapp.zip -o$TOME/gapp >/dev/null
 tar -xJf $TOME/gapp/files/files.tar.xz -C $TOME/gapp 2>/dev/null 
 sudo cp -rf $TOME/gapp/arm64/*/system/* $TOME/cauhinh 2>/dev/null 
 sudo cp -rf $TOME/cauhinh/* $phanvungtam
 for tt in $(find $TOME/cauhinh/product -type f); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0644' >> $TOME/pfs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for tt in $(find $TOME/cauhinh/product -type d); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0755' >> $TOME/pfs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for tt in $(find $TOME/cauhinh/system_ext -type f); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0644' >> $TOME/sefs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/sefc"; done
 for tt in $(find $TOME/cauhinh/system_ext -type d); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0755' >> $TOME/sefs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/sefc"; done
 for i in sefc sefs pfs pfc; do sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done
 sudo rm -rf $TOME/{gapp,cauhinh} $TOME/gapp.zip $TOME/gboad.zip
 elif [[ "$(du -m $TOME/nikgapp.zip | awk '{print $1}')" -gt 20 ]]; then echo " * Thêm Gói NikGapp..."
 mkdir -p $TOME/gapp $TOME/tam
 7za x -tzip -y $TOME/nikgapp.zip -o$TOME/tam >/dev/null
 for f in $TOME/tam/AppSet/CarrierServices/*.zip $TOME/tam/AppSet/Core/*.zip; do 
 tm=${f//.zip/}; ttm=${tm##*/}; mkdir -p $TOME/gapp/$ttm; 
 7za x -tzip -y $f -o$TOME/gapp/$ttm >/dev/null
 done
 for t in $TOME/gapp/*/*; do
  if [[ -d $t ]]; then 
   t1=$(echo $t | awk -F___ '{print $2}')
   t2=$(echo $t | awk -F___ '{print $3}')
   t3=$(echo $t | awk -F___ '{print $4}')
   t4=$(echo $t | awk -F___ '{print $5}')
   t5=$(echo $t | awk -F___ '{print $6}')
   tm="$TOME/cauhinh/product/$t1/$t2/$t3/$t4/$t5"
    mkdir -p $tm 
    sudo cp -rf $t/* $tm
  fi
 done
 sudo cp -rf $TOME/cauhinh/product/* $phanvungtam/product
 for tt in $(find $TOME/cauhinh/product -type f); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0644' >> $TOME/pfs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for tt in $(find $TOME/cauhinh/product -type d); do sudo bash -c "echo '${tt//$TOME\/cauhinh\//} 0 0 0755' >> $TOME/pfs"; ttm="${tt//$TOME\/cauhinh/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for i in pfs pfc; do sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done
 sudo rm -rf $TOME/{tam,gapp,cauhinh} $TOME/nikgapp.zip
 fi
fi
if [[ "$APPM" == "1" ]]; then 
 Taive "https://sourceforge.net/projects/kudopatch/files/twrp/MiuiMod14.zip" "$TOME/appm.zip"
 if [[ "$(du -m $TOME/appm.zip | awk '{print $1}')" -gt 100 ]]; then echo " * Thêm App Mod..."
 mkdir -p $TOME/tam
 7za x -tzip -y $TOME/appm.zip -o$TOME/tam >/dev/null
 for a in $TOME/tam/product/app/*; do 
  tm=${a//Miui/MIUI}; ttm=${a##*/}; tmm=${ttm//Miui/MIUI}; 
  mv -f $a $tm 2>/dev/null
  mv -f $tm/$ttm.apk $tm/$tmm.apk 2>/dev/null
 done
 for tt in $(find $TOME/tam/product/*app -type d); do sudo bash -c "echo '${tt//$TOME\/tam\//} 0 0 0755' >> $TOME/pfs"; ttm="${tt//$TOME\/tam/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for tt in $(find $TOME/tam/product/*app -type f); do sudo bash -c "echo '${tt//$TOME\/tam\//} 0 0 0644' >> $TOME/pfs"; ttm="${tt//$TOME\/tam/}"; sudo bash -c "echo '${ttm//./\\.} u:object_r:system_file:s0' >> $TOME/pfc"; done
 for i in pfs pfc; do sudo sed -i -e 's/\r$//g; /^$/d' $TOME/$i; done

  sudo cp -rf $TOME/tam/product/*app $phanvungtam/product 2>/dev/null
  sudo cp -rf $TOME/tam/vendor/*app $phanvungtam/vendor 2>/dev/null
  sudo cp -rf $TOME/tam/system_ext/*app $phanvungtam/system_ext 2>/dev/null
  sudo cp -rf $TOME/tam/system/*app $phanvungtam/system/system 2>/dev/null
  sudo rm -rf $TOME/tam $TOME/appm.zip
 fi
fi
#
themcauhinh
